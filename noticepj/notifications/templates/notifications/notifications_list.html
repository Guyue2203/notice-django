{% load static %}
<link rel="stylesheet" href="{% static 'css/notifications.css' %}">

<div class="page-wrapper">
  <div class="page-header">
    <h1 class="page-title">é€šçŸ¥</h1>
    <div class="user-status">
      {% if request.user.is_authenticated %}
        <span class="user-info">
          <span class="username">{{ request.user.username }}</span>
        </span>
        <button type="button" class="logout-btn" onclick="logoutUser()">é€€å‡º</button>
      {% else %}
        <a href="{% url 'login' %}?next=/notifications/" class="login-btn">ç™»å½•</a>
      {% endif %}
    </div>
  </div>

  <div class="notifications-container">
  {% if not request.user.is_authenticated %}
  <div class="auth-alert">
    <span class="icon">ğŸ”’</span>
    <p>ç™»å½•åå¯æŸ¥çœ‹ç§äººé€šçŸ¥</p>
  </div>
  {% endif %}

  <ul class="notification-list">
  {% for notif in notifications %}
    <li class="notification-item d-flex align-items-center gap-3">
      <div class="notification-content">
        {% if notif.receiver %}
          <div class="notification-line">
            <span class="badge badge-private">ç§ä¿¡</span>
            {% if notif.sender %}
              <span class="notification-sender">{{ notif.sender.username }}</span>
              <span class="arrow">â†’</span>
              <span class="notification-sender">{{ notif.receiver.username }}</span>
              <span class="notification-message">ï¼š{{ notif.message }}</span>
            {% else %}
              <span class="notification-sender">æœªçŸ¥</span>
              <span class="arrow">â†’</span>
              <span class="notification-sender">{{ notif.receiver.username }}</span>
              <span class="notification-message">ï¼š{{ notif.message }}</span>
            {% endif %}
          </div>
          {% if not notif.is_read and request.user == notif.receiver %}
          <a class="mark-read-btn" href="{% url 'mark_read' notif.id %}">
            <span class="icon">âœ“</span> æ ‡è®°å·²è¯»
          </a>
          {% endif %}
        {% else %}
          <div class="notification-line">
            <span class="badge badge-public">å…¬å‘Š</span>
            {% if notif.sender %}
              <span class="notification-sender">{{ notif.sender.username }}</span>
              <span class="notification-message">ï¼š{{ notif.message }}</span>
            {% else %}
              <span class="notification-sender">ç³»ç»Ÿ</span>
              <span class="notification-message">ï¼š{{ notif.message }}</span>
            {% endif %}
          </div>
        {% endif %}

        <div class="notification-time">
          <span class="icon">ğŸ•</span>
          <span>{{ notif.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
          {% if notif.receiver and notif.is_read %}
            <span class="read-status">
              <span class="icon">âœ“</span> å·²è¯»
            </span>
          {% endif %}
        </div>
      </div>
    </li>
  {% empty %}
    <li class="empty-notification">æš‚æ— é€šçŸ¥</li>
  {% endfor %}
  </ul>
</div>

<script src="{% static 'js/notifications.js' %}"></script>

<script>
function logoutUser() {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        // åˆ›å»ºè¡¨å•æ•°æ®
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        // å‘é€AJAXè¯·æ±‚
        fetch('{% url "ajax_logout" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é€€å‡ºæˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        })
        .catch(error => {
            console.error('é€€å‡ºè¯·æ±‚å¤±è´¥:', error);
            alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
}
</script>
